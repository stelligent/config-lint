version: 1
description: Rules for Kubernetes spec files
type: Kubernetes
files:
  - "*.yml"
  - "*.yaml"
rules:

  - id: ALLOW_KIND
    severity: FAILURE
    message: Allowed kinds
    resource: "*"
    assertions:
      - key: kind
        op: in
        value: Pod,Policy,ServiceAccount,NetworkPolicy,Service,Deployment,ConfigMap,Ingress,PersistentVolumeClaim,Job,Secret,StatefulSet
    tags:
      - kind

  - id: POD_CONTAINERS
    severity: FAILURE
    message: Pod must include containers
    resource: Pod
    assertions:
      - key: spec.containers
        op: present
    tags:
      - pod

  - id: DEPLOYMENT_CONTAINERS
    severity: FAILURE
    message: Deployment must include containers
    resource: Deployment
    assertions:
      - key: spec.template.spec.containers
        op: present
    tags:
      - deployment
      - container

  - id: POD_SERVICE_ACCOUNT
    severity: FAILURE
    message: Pod should use a service account
    resource: Pod
    assertions:
      - key: serviceAccountName
        op: present
    tags:
      - pod

  - id: POD_SECURITY_CONTEXT
    severity: FAILURE
    message: Pod should set securityContexts
    resource: Pod
    assertions:
      - key: spec.securityContext.runAsNonRoot
        op: eq
        value: true
      - key: spec.securityContext.readOnlyRootFilesystem
        op: eq
        value: true
    tags:
      - pod
      - security
      
  - id: DEPLOYMENT_POD_MUSTNONROOT_SECURITY_CONTEXT
    severity: NON_COMPLIANT
    message: Deployment pod should set runAsNonRoot securityContext
    resource: Deployment
    assertions:
      - key: spec.template.spec.securityContext.runAsNonRoot
        op: eq
        value: true
    tags:
      - deployment
      - security

  - id: DEPLOYMENT_POD_READONLYFS_SECURITY_CONTEXT
    severity: NON_COMPLIANT
    message: Deployment pod should set readOnlyRootFilesystem securityContext
    resource: Deployment
    assertions:
      - key: spec.template.spec.securityContext.readOnlyRootFilesystem
        op: eq
        value: true
    tags:
      - deployment
      - security

  - id: DEPLOYMENT_CONTAINER_MUSTNONROOT_SECURITY_CONTEXT
    severity: NON_COMPLIANT
    message: Deployment containers should set runAsNonRoot securityContext
    resource: Deployment
    assertions:
      - every:
          key: spec.template.spec.containers
          expressions:
            - key: securityContext.runAsNonRoot
              op: is-true
    tags:
      - deployment
      - security

  - id: DEPLOYMENT_CONTAINER_READONLYFS_SECURITY_CONTEXT
    severity: NON_COMPLIANT
    message: Deployment containers should set readOnlyRootFilesystem securityContext
    resource: Deployment
    assertions:
      - every:
          key: spec.template.spec.containers
          expressions:
            - key: securityContext.readOnlyRootFilesystem
              op: is-true
    tags:
      - deployment
      - security

  - id: POLICY
    severity: FAILURE
    message: Policy must include a spec
    resource: Policy
    assertions:
      - key: spec
        op: present
    tags:
      - policy

  - id: DEFAULT_NAMESPACE
    severity: FAILURE
    message: Policy should not use default namespace
    resource: Policy
    assertions:
      - key: spec.namespace
        op: ne
        value: default
    tags:
      - policy

  - id: CUSTOM
    severity: FAILURE
    message: Custom
    resource: Policy
    invoke:
      url: https://19kfojjbi2.execute-api.us-east-1.amazonaws.com/dev/failure
      payload: "{ user: spec.user, namespace: spec.namespace }"
    tags:
      - custom

  - id: NETWORK
    severity: FAILURE
    message: Network policy should include from pods
    resource: NetworkPolicy
    assertions:
      - key: spec.allowIncoming.from[].pods
        op: present
    tags:
      - network
